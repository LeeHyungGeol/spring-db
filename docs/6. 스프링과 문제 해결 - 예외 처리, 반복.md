# 6. μ¤ν”„λ§κ³Ό λ¬Έμ  ν•΄κ²° - μμ™Έ μ²λ¦¬, λ°λ³µ<br/>## λ©μ°¨-  μ²΄ν¬ μμ™Έμ™€ μΈν„°νμ΄μ¤<br/><br/><br/># π’΅ μ²΄ν¬ μμ™Έμ™€ μΈν„°νμ΄μ¤> **interface λ¥Ό λ„μ…ν•  λ•λ„, Unchecked Exception μ„ μ‚¬μ©ν•μ.**> > `Checked Exception` μ„ μ‚¬μ©ν•λ©΄, interface μ—λ„ μμ™Έλ¥Ό μ„ μ–Έν•΄μ•Ό ν•λ‹¤. interface κ°€ νΉμ • κΈ°μ μ— μΆ…μ†λλ” λ¬Έμ λ¥Ό λ°μƒμ‹ν‚¨λ‹¤.> > `RuntimeException` μ„ μ‚¬μ©ν•λ©΄, interface μ— μμ™Έλ¥Ό μ„ μ–Έν•μ§€ μ•μ•„λ„ λλ‹¤. interface κ°€ νΉμ • κΈ°μ μ— μΆ…μ†λμ§€ μ•λ”λ‹¤.μ„λΉ„μ¤ κ³„μΈµμ€ κ°€κΈ‰μ  νΉμ • κµ¬ν„ κΈ°μ μ— μμ΅΄ν•μ§€ μ•κ³ , μμν•κ² μ μ§€ν•λ” κ²ƒμ΄ μΆ‹λ‹¤. μ΄λ ‡κ² ν•λ ¤λ©΄ μμ™Έμ— λ€ν• μμ΅΄λ„ ν•¨κ» ν•΄κ²°ν•΄μ•Όν•λ‹¤.μλ¥Ό λ“¤μ–΄μ„ μ„λΉ„μ¤κ°€ μ²λ¦¬ν•  μ μ—†λ” `SQLException` μ— λ€ν• μμ΅΄μ„ μ κ±°ν•λ ¤λ©΄ μ–΄λ–»κ² ν•΄μ•Όν• κΉ?μ„λΉ„μ¤κ°€ μ²λ¦¬ν•  μ μ—†μΌλ―€λ΅ λ¦¬ν¬μ§€ν† λ¦¬κ°€ λμ§€λ” `SQLException` μ²΄ν¬ μμ™Έλ¥Ό λ°νƒ€μ„ μμ™Έλ΅ μ „ν™ν•΄μ„ μ„λΉ„μ¤ κ³„μΈµμ— λμ§€μ.μ΄λ ‡κ² ν•λ©΄ μ„λΉ„μ¤ κ³„μΈµμ΄ ν•΄λ‹Ή μμ™Έλ¥Ό λ¬΄μ‹ν•  μ μκΈ° λ•λ¬Έμ—, νΉμ • κµ¬ν„ κΈ°μ μ— μμ΅΄ν•λ” λ¶€λ¶„μ„ μ κ±°ν•κ³  μ„λΉ„μ¤ κ³„μΈµμ„ μμν•κ² μ μ§€ν•  μ μλ‹¤.## **β΅οΈ μΈν„°νμ΄μ¤ λ„μ…**λ¨Όμ € MemberRepository μΈν„°νμ΄μ¤λ„ λ„μ…ν•΄μ„ κµ¬ν„ κΈ°μ μ„ μ‰½κ² λ³€κ²½ν•  μ μκ² ν•΄λ³΄μ.ν„μ¬λ” κµ¬ν„μ²΄λ¥Ό μμ΅΄μ¤‘μ΄λ‹¤.```java@Slf4j@RequiredArgsConstructorpublic class MemberServiceV3_3 {    private final MemberRepositoryV3 memberRepository;...}```![image](https://user-images.githubusercontent.com/83503188/188806467-07240979-3791-44cf-956c-58e156efcf16.png)- μ΄λ ‡κ² μΈν„°νμ΄μ¤λ¥Ό λ„μ…ν•λ©΄ MemberService λ” MemberRepository μΈν„°νμ΄μ¤μ—λ§ μμ΅΄ν•λ©΄ λλ‹¤.- μ΄μ  κµ¬ν„ κΈ°μ μ„ λ³€κ²½ν•κ³  μ‹¶μΌλ©΄ DIλ¥Ό μ‚¬μ©ν•΄μ„ MemberService μ½”λ“μ λ³€κ²½ μ—†μ΄ κµ¬ν„ κΈ°μ μ„ λ³€κ²½ν•  μ μλ‹¤.**MemberRepository μΈν„°νμ΄μ¤**```javapublic interface MemberRepository {    Member save(Member member);    Member findById(String memberId);    void update(String memberId, int money);    void delete(String memberId);}```νΉμ • κΈ°μ μ— μΆ…μ†λμ§€ μ•λ” μμν• μΈν„°νμ΄μ¤μ΄λ‹¤. μ΄ μΈν„°νμ΄μ¤λ¥Ό κΈ°λ°μΌλ΅ νΉμ • κΈ°μ μ„ μ‚¬μ©ν•λ” κµ¬ν„μ²΄λ¥Ό λ§λ“¤λ©΄ λλ‹¤.**μ²΄ν¬ μμ™Έμ™€ μΈν„°νμ΄μ¤**κΈ°μ΅΄μ—λ” μ™ μ΄λ° μΈν„°νμ΄μ¤λ¥Ό λ§λ“¤μ§€ μ•μ•μ„κΉ? μ‚¬μ‹¤ λ‹¤μκ³Ό κ°™μ€ λ¬Έμ κ°€ μκΈ° λ•λ¬Έμ— λ§λ“¤μ§€ μ•μ•λ‹¤.μ™λƒν•λ©΄ `SQLException` μ΄ μ²΄ν¬ μμ™Έμ΄κΈ° λ•λ¬Έμ΄λ‹¤. μ—¬κΈ°μ„ μ²΄ν¬ μμ™Έκ°€ λ λ°λ©μ„ μ΅λ”λ‹¤.μ²΄ν¬ μμ™Έλ¥Ό μ‚¬μ©ν•λ ¤λ©΄ μΈν„°νμ΄μ¤μ—λ„ ν•΄λ‹Ή μ²΄ν¬ μμ™Έκ°€ μ„ μ–Έ λμ–΄ μμ–΄μ•Ό ν•λ‹¤.μλ¥Ό λ“¤λ©΄ λ‹¤μκ³Ό κ°™μ€ μ½”λ“κ°€ λλ‹¤.**μ²΄ν¬ μμ™Έ μ½”λ“μ— μΈν„°νμ΄μ¤ λ„μ…μ‹ λ¬Έμ μ  - μΈν„°νμ΄μ¤**```javapublic interface MemberRepositoryEx {    Member save(Member member) throws SQLException;    Member findById(String memberId) throws SQLException;    void update(String memberId, int money) throws SQLException;    void delete(String memberId) throws SQLException;}```- μΈν„°νμ΄μ¤μ λ©”μ„λ“μ— `throws SQLException` μ΄ μλ” κ²ƒμ„ ν™•μΈν•  μ μλ‹¤.- μΆ…μ†μ„± λ¬Έμ λ¥Ό ν•΄κ²°ν•κΈ° μ„ν•΄ μΈν„°νμ΄μ¤λ¥Ό λ§λ“¤μ—λ”λ° JDBCμ— μΆ…μ†μ μΈ μΈν„°νμ΄μ¤κ°€ λΌ λ²„λ¦°λ‹¤.**μ²΄ν¬ μμ™Έ μ½”λ“μ— μΈν„°νμ΄μ¤ λ„μ…μ‹ λ¬Έμ μ  - κµ¬ν„ ν΄λμ¤**```java@Slf4jpublic class MemberRepositoryV3 implements MemberRepositoryEx {    public Member save(Member member) throws SQLException {        String sql = "insert into member(member_id, money) values(?, ?)";      ...    }}```- μΈν„°νμ΄μ¤μ κµ¬ν„μ²΄κ°€ μ²΄ν¬ μμ™Έλ¥Ό λμ§€λ ¤λ©΄, μΈν„°νμ΄μ¤ λ©”μ„λ“μ— λ¨Όμ € μ²΄ν¬ μμ™Έλ¥Ό λμ§€λ” λ¶€λ¶„μ΄ μ„ μ–Έ λμ–΄ μμ–΄μ•Ό ν•λ‹¤. κ·Έλμ•Ό κµ¬ν„ ν΄λμ¤μ λ©”μ„λ“λ„ μ²΄ν¬ μμ™Έλ¥Ό λμ§ μ μλ‹¤.    - μ‰½κ² μ΄μ•ΌκΈ° ν•΄μ„ `MemberRepositoryV3` κ°€ `throws SQLException` λ¥Ό ν•λ ¤λ©΄ `MemberRepositoryEx` μΈν„°νμ΄μ¤μ—λ„ `throws SQLException` μ΄ ν•„μ”ν•λ‹¤.- μ°Έκ³ λ΅ κµ¬ν„ ν΄λμ¤μ λ©”μ„λ“μ— μ„ μ–Έν•  μ μλ” μμ™Έλ” λ¶€λ¨ νƒ€μ…μ—μ„ λμ§„ μμ™Έμ™€ κ°™κ±°λ‚ ν•μ„ νƒ€μ…μ΄μ–΄μ•Ό ν•λ‹¤.    - μλ¥Ό λ“¤μ–΄μ„ μΈν„°νμ΄μ¤ λ©”μ„λ“μ— `throws Exception` λ¥Ό μ„ μ–Έν•λ©΄, κµ¬ν„ ν΄λμ¤ λ©”μ„λ“μ— `throws SQLException` λ” κ°€λ¥ν•λ‹¤. `SQLException` μ€ `Exception` μ ν•μ„ νƒ€μ…μ΄κΈ° λ•λ¬Έμ΄λ‹¤.![image](https://user-images.githubusercontent.com/83503188/188807973-b31d1d8a-60dd-4eaa-af00-8cad11694992.png)![image](https://user-images.githubusercontent.com/83503188/188808001-776d9d92-52c8-4a58-8ee9-0b6f627e9391.png)## **β΅οΈ νΉμ • κΈ°μ μ— μΆ…μ†λλ” μΈν„°νμ΄μ¤ - Checked Exception**κµ¬ν„ κΈ°μ μ„ μ‰½κ² λ³€κ²½ν•κΈ° μ„ν•΄μ„ μΈν„°νμ΄μ¤λ¥Ό λ„μ…ν•λ”λΌλ„ `SQLException` κ³Ό κ°™μ€ νΉμ • κµ¬ν„ κΈ°μ μ— μΆ…μ†μ μΈ μ²΄ν¬ μμ™Έλ¥Ό μ‚¬μ©ν•κ² λλ©΄ μΈν„°νμ΄μ¤μ—λ„ ν•΄λ‹Ή μμ™Έλ¥Ό ν¬ν•¨ν•΄μ•Ό ν•λ‹¤.ν•μ§€λ§ μ΄κ²ƒμ€ μ°λ¦¬κ°€ μ›ν•λ μμν• μΈν„°νμ΄μ¤κ°€ μ•„λ‹λ‹¤.JDBC κΈ°μ μ— μΆ…μ†μ μΈ μΈν„°νμ΄μ¤μΌ λΏμ΄λ‹¤. μΈν„°νμ΄μ¤λ¥Ό λ§λ“λ” λ©μ μ€ κµ¬ν„μ²΄λ¥Ό μ‰½κ² λ³€κ²½ν•κΈ° μ„ν•¨μΈλ°, μ΄λ―Έ μΈν„°νμ΄μ¤κ°€ νΉμ • κµ¬ν„ κΈ°μ μ— μ¤μ—Όμ΄ λμ–΄ λ²„λ Έλ‹¤. ν–¥ν›„ JDBCκ°€ μ•„λ‹ λ‹¤λ¥Έ κΈ°μ λ΅ λ³€κ²½ν•λ‹¤λ©΄ μΈν„°νμ΄μ¤ μμ²΄λ¥Ό λ³€κ²½ν•΄μ•Ό ν•λ‹¤.## **β΅οΈ RuntimeException μ™€ μΈν„°νμ΄μ¤****λ°νƒ€μ„ μμ™Έλ” μ΄λ° λ¶€λ¶„μ—μ„ μμ λ΅­λ‹¤. μΈν„°νμ΄μ¤μ— λ°νƒ€μ„ μμ™Έλ¥Ό λ”°λ΅ μ„ μ–Έν•μ§€ μ•μ•„λ„ λλ‹¤.   λ”°λΌμ„ μΈν„°νμ΄μ¤κ°€ νΉμ • κΈ°μ μ— μΆ…μ†μ μΌ ν•„μ”κ°€ μ—†λ‹¤.**<br/><br/><br/># π’΅ λ°νƒ€μ„ μμ™Έ μ μ©**MemberRepository μΈν„°νμ΄μ¤**```javapublic interface MemberRepository {    Member save(Member member);    Member findById(String memberId);    void update(String memberId, int money);    void delete(String memberId);}   ```**MyDbException λ°νƒ€μ„ μμ™Έ**```javapublic class MyDbException extends RuntimeException {    public MyDbException() {    }    public MyDbException(String message) {        super(message);    }    public MyDbException(String message, Throwable cause) {        super(message, cause);    }    public MyDbException(Throwable cause) {        super(cause);    }}```- `RuntimeException` μ„ μƒμ†λ°›μ•λ‹¤. λ”°λΌμ„ `MyDbException` μ€ λ°νƒ€μ„(μ–Έμ²΄ν¬) μμ™Έκ°€ λλ‹¤.**MemberRepositoryV4_1**```java@Slf4jpublic class MemberRepositoryV4_1 implements MemberRepository {    private final DataSource dataSource;    public MemberRepositoryV4_1(DataSource dataSource) {        this.dataSource = dataSource;    }    public Member save(Member member) {        String sql = "insert into member(member_id, money) values (?, ?)";        Connection con = null;        PreparedStatement pstmt = null; // PreparedStatement κ°μ²΄λ¥Ό κ°€μ§€κ³  μ‹¤μ  DBμ— μΏΌλ¦¬λ¥Ό μ‹¤ν–‰ν•λ‹¤.        try {            con = getConnection();            pstmt = con.prepareStatement(sql);            // νλΌλ―Έν„° λ°”μΈλ”©            pstmt.setString(1, member.getMemberId());            pstmt.setInt(2, member.getMoney());            pstmt.executeUpdate(); // μΏΌλ¦¬ μ‹¤ν–‰, λ°ν™κ°’μ€ μν–¥μ„ λ°›μ€ row μ            return member;        } catch (SQLException e) {            throw new MyDbException(e);        } finally {            close(con, pstmt, null);        }    }...}```- `MemberRepository` μΈν„°νμ΄μ¤λ¥Ό κµ¬ν„ν•λ‹¤.- μ΄ μ½”λ“μ—μ„ ν•µμ‹¬μ€ `SQLException` μ΄λΌλ” μ²΄ν¬ μμ™Έλ¥Ό `MyDbException` μ΄λΌλ” λ°νƒ€μ„ μμ™Έλ΅ λ³€ν™ν•΄μ„ λμ§€λ” λ¶€λ¶„μ΄λ‹¤.**μμ™Έ λ³€ν™**```javacatch (SQLException e) {    throw new MyDbException(e);}```- μ λ³΄λ©΄ κΈ°μ΅΄ μμ™Έλ¥Ό μƒμ„±μλ¥Ό ν†µν•΄μ„ ν¬ν•¨ν•κ³  μλ” κ²ƒμ„ ν™•μΈν•  μ μλ‹¤. μμ™Έλ” μ›μΈμ΄ λλ” μμ™Έλ¥Ό λ‚΄λ¶€μ— ν¬ν•¨ν•  μ μλ”λ°, κΌ­ μ΄λ ‡κ² μ‘μ„±ν•΄μ•Ό ν•λ‹¤. κ·Έλμ•Ό μμ™Έλ¥Ό μ¶λ ¥ν–μ„ λ• μ›μΈμ΄ λλ” κΈ°μ΅΄ μμ™Έλ„ ν•¨κ» ν™•μΈν•  μ μλ‹¤.- `MyDbException` μ΄ λ‚΄λ¶€μ— `SQLException` μ„ ν¬ν•¨ν•κ³  μλ‹¤κ³  μ΄ν•΄ν•λ©΄ λλ‹¤. μμ™Έλ¥Ό μ¶λ ¥ν–μ„ λ• μ¤νƒ νΈλ μ΄μ¤λ¥Ό ν†µν•΄ λ‘λ‹¤ ν™•μΈν•  μ μλ‹¤.**μμ™Έ λ³€ν™ - κΈ°μ΅΄ μμ™Έ λ¬΄μ‹**```javacatch (SQLException e) {    throw new MyDbException();}```- μ λ³΄λ©΄ `new MyDbException()` μΌλ΅ ν•΄λ‹Ή μμ™Έλ§ μƒμ„±ν•κ³  κΈ°μ΅΄μ— μλ” `SQLException` μ€ ν¬ν•¨ν•μ§€ μ•κ³  λ¬΄μ‹ν•λ‹¤.- λ”°λΌμ„ `MyDbException` μ€ λ‚΄λ¶€μ— μ›μΈμ΄ λλ” λ‹¤λ¥Έ μμ™Έλ¥Ό ν¬ν•¨ν•μ§€ μ•λ”λ‹¤.- μ΄λ ‡κ² μ›μΈμ΄ λλ” μμ™Έλ¥Ό λ‚΄λ¶€μ— ν¬ν•¨ν•μ§€ μ•μΌλ©΄, μμ™Έλ¥Ό μ¤νƒ νΈλ μ΄μ¤λ¥Ό ν†µν•΄ μ¶λ ¥ν–μ„ λ• κΈ°μ΅΄μ— μ›μΈμ΄ λλ” λ¶€λ¶„μ„ ν™•μΈν•  μ μ—†λ‹¤.    - λ§μ•½ `SQLException` μ—μ„ λ¬Έλ²• μ¤λ¥κ°€ λ°μƒν–λ‹¤λ©΄ κ·Έ λ¶€λ¶„μ„ ν™•μΈν•  λ°©λ²•μ΄ μ—†κ² λλ‹¤.**MemberServiceV4**```java/** * μμ™Έ λ„μ λ¬Έμ  ν•΄κ²° * SQLException μ κ±° * * MemberRepository μΈν„°νμ΄μ¤ μμ΅΄ */@Slf4j@RequiredArgsConstructorpublic class MemberServiceV4 {    private final MemberRepository memberRepository;    @Transactional    public void accountTransfer(String fromId, String toId, int money) {        bizLogic(fromId, toId, money);    }    private void bizLogic(String fromId, String toId, int money) {        Member fromMember = memberRepository.findById(fromId);        Member toMember = memberRepository.findById(toId);        memberRepository.update(fromId, fromMember.getMoney() - money);        // fromMemberμ κ³„μΆλ¥Ό μ—…λ°μ΄νΈν•κ³  κ²€μ¦μ—μ„ μ‹¤ν¨ν•λ‹¤λ©΄?        validation(toMember);        memberRepository.update(toId, toMember.getMoney() + money);    }...}```- `MemberRepository` μΈν„°νμ΄μ¤μ— μμ΅΄ν•λ„λ΅ μ½”λ“λ¥Ό λ³€κ²½ν–λ‹¤.- `MemberServiceV3_3` μ™€ λΉ„κµν•΄μ„ λ³΄λ©΄ λ“λ””μ–΄ λ©”μ„λ“μ—μ„ `throws SQLException` λ¶€λ¶„μ΄ μ κ±°λ κ²ƒμ„ ν™•μΈν•  μ μλ‹¤.<br/><br/>## **β΅οΈ μ •λ¦¬**- μ²΄ν¬ μμ™Έλ¥Ό λ°νƒ€μ„ μμ™Έλ΅ λ³€ν™ν•λ©΄μ„ μΈν„°νμ΄μ¤μ™€ μ„λΉ„μ¤ κ³„μΈµμ μμμ„±μ„ μ μ§€ν•  μ μκ² λμ—λ‹¤.- λ•λ¶„μ— ν–¥ν›„ JDBCμ—μ„ λ‹¤λ¥Έ κµ¬ν„ κΈ°μ λ΅ λ³€κ²½ν•λ”λΌλ„ μ„λΉ„μ¤ κ³„μΈµμ μ½”λ“λ¥Ό λ³€κ²½ν•μ§€ μ•κ³  μ μ§€ν•  μ μλ‹¤.<br/>## **β΅οΈ λ‚¨μ€ λ¬Έμ  - νΉμ • κΈ°μ μ— μΆ…μ†λμ§€ μ•κ² μƒν™©λ³„λ΅ μμ™Έλ¥Ό κµ¬λ¶„ν•λ” λ°©λ²•???**λ¦¬ν¬μ§€ν† λ¦¬μ—μ„ λ„μ–΄μ¤λ” νΉμ •ν• μμ™Έμ κ²½μ° λ³µκµ¬λ¥Ό μ‹λ„ν•  μλ„ μλ‹¤. κ·Έλ°λ° μ§€κΈ λ°©μ‹μ€ ν•­μƒ `MyDbException` μ΄λΌλ” μμ™Έλ§ λ„μ–΄μ¤κΈ° λ•λ¬Έμ— μμ™Έλ¥Ό κµ¬λ¶„ν•  μ μ—†λ” λ‹¨μ μ΄ μλ‹¤.λ§μ•½ νΉμ • μƒν™©μ—λ” μμ™Έλ¥Ό μ΅μ•„μ„ λ³µκµ¬ν•κ³  μ‹¶μΌλ©΄ μμ™Έλ¥Ό μ–΄λ–»κ² κµ¬λ¶„ν•΄μ„ μ²λ¦¬ν•  μ μμ„κΉ?   -> **νΉμ • κΈ°μ μ— μΆ…μ†λμ§€ μ•κ² μƒν™©λ³„λ΅ μμ™Έλ¥Ό κµ¬λ¶„ν•λ” λ°©λ²•?**<br/><br/><br/>### λ°μ΄ν„° μ ‘κ·Ό μμ™Έ μ§μ ‘ λ§λ“¤κΈ°λ°μ΄ν„°λ² μ΄μ¤ μ¤λ¥μ— λ”°λΌμ„ νΉμ • μμ™Έλ” λ³µκµ¬ν•κ³  μ‹¶μ„ μ μλ‹¤.μλ¥Ό λ“¤μ–΄μ„ νμ› κ°€μ…μ‹ DBμ— μ΄λ―Έ κ°™μ€ IDκ°€ μμΌλ©΄ ID λ’¤μ— μ«μλ¥Ό λ¶™μ—¬μ„ μƒλ΅μ΄ IDλ¥Ό λ§λ“¤μ–΄μ•Ό ν•λ‹¤κ³  κ°€μ •ν•΄λ³΄μ.IDλ¥Ό `hello` λΌκ³  κ°€μ… μ‹λ„ ν–λ”λ°, μ΄λ―Έ κ°™μ€ μ•„μ΄λ””κ°€ μμΌλ©΄ `hello12345` μ™€ κ°™μ΄ λ’¤μ— μ„μμ μ«μλ¥Ό λ¶™μ—¬μ„ κ°€μ…ν•λ” κ²ƒμ΄λ‹¤.λ°μ΄ν„°λ¥Ό DBμ— μ €μ¥ν•  λ• κ°™μ€ IDκ°€ μ΄λ―Έ λ°μ΄ν„°λ² μ΄μ¤μ— μ €μ¥λμ–΄ μλ‹¤λ©΄, λ°μ΄ν„°λ² μ΄μ¤λ” μ¤λ¥ μ½”λ“λ¥Ό λ°ν™ν•κ³ , μ΄ μ¤λ¥ μ½”λ“λ¥Ό λ°›μ€ JDBC λ“λΌμ΄λ²„λ” `SQLException` μ„ λμ§„λ‹¤. κ·Έλ¦¬κ³  `SQLException` μ—λ” λ°μ΄ν„°λ² μ΄μ¤κ°€ μ κ³µν•λ” errorCode λΌλ” κ²ƒμ΄ λ“¤μ–΄μλ‹¤.**λ°μ΄ν„°λ² μ΄μ¤ μ¤λ¥ μ½”λ“ κ·Έλ¦Ό**![image](https://user-images.githubusercontent.com/83503188/188811749-b3150c82-0627-491f-8957-5dc96f38ef33.png)**H2 λ°μ΄ν„°λ² μ΄μ¤μ ν‚¤ μ¤‘λ³µ μ¤λ¥ μ½”λ“**```javae.getErrorCode() == 23505````SQLException` λ‚΄λ¶€μ— λ“¤μ–΄μλ” `errorCode` λ¥Ό ν™μ©ν•λ©΄ λ°μ΄ν„°λ² μ΄μ¤μ—μ„ μ–΄λ–¤ λ¬Έμ κ°€ λ°μƒν–λ”μ§€ ν™•μΈν•  μ μλ‹¤.**H2 λ°μ΄ν„°λ² μ΄μ¤ μ**- `23505` : ν‚¤ μ¤‘λ³µ μ¤λ¥- `42000` : SQL λ¬Έλ²• μ¤λ¥μ°Έκ³ λ΅ κ°™μ€ μ¤λ¥μ—¬λ„ κ°κ°μ λ°μ΄ν„°λ² μ΄μ¤λ§λ‹¤ μ •μλ μ¤λ¥ μ½”λ“κ°€ λ‹¤λ¥΄λ‹¤. λ”°λΌμ„ μ¤λ¥ μ½”λ“λ¥Ό μ‚¬μ©ν•  λ•λ” λ°μ΄ν„°λ² μ΄μ¤ λ©”λ‰΄μ–Όμ„ ν™•μΈν•΄μ•Ό ν•λ‹¤.**μ) ν‚¤ μ¤‘λ³µ μ¤λ¥ μ½”λ“**- H2 DB: `23505`- MySQL: `1062`μ„λΉ„μ¤ κ³„μΈµμ—μ„λ” μμ™Έ λ³µκµ¬λ¥Ό μ„ν•΄ ν‚¤ μ¤‘λ³µ μ¤λ¥λ¥Ό ν™•μΈν•  μ μμ–΄μ•Ό ν•λ‹¤. κ·Έλμ•Ό μƒλ΅μ΄ IDλ¥Ό λ§λ“¤μ–΄μ„ λ‹¤μ‹ μ €μ¥μ„ μ‹λ„ν•  μ μκΈ° λ•λ¬Έμ΄λ‹¤. μ΄λ¬ν• κ³Όμ •μ΄ λ°”λ΅ μμ™Έλ¥Ό ν™•μΈν•΄μ„ λ³µκµ¬ν•λ” κ³Όμ •μ΄λ‹¤.λ¦¬ν¬μ§€ν† λ¦¬λ” `SQLException` μ„ μ„λΉ„μ¤ κ³„μΈµμ— λμ§€κ³  μ„λΉ„μ¤ κ³„μΈµμ€ μ΄ μμ™Έμ μ¤λ¥ μ½”λ“λ¥Ό ν™•μΈν•΄μ„ ν‚¤ μ¤‘λ³µ μ¤λ¥( `23505` )μΈ κ²½μ° μƒλ΅μ΄ IDλ¥Ό λ§λ“¤μ–΄μ„ λ‹¤μ‹ μ €μ¥ν•λ©΄ λλ‹¤.κ·Έλ°λ° `SQLException` μ— λ“¤μ–΄μλ” μ¤λ¥ μ½”λ“λ¥Ό ν™μ©ν•κΈ° μ„ν•΄ `SQLException` μ„ μ„λΉ„μ¤ κ³„μΈµμΌλ΅ λμ§€κ² λλ©΄, μ„λΉ„μ¤ κ³„μΈµμ΄ `SQLException` μ΄λΌλ” JDBC κΈ°μ μ— μμ΅΄ν•κ² λλ©΄μ„, μ§€κΈκΉμ§€ μ°λ¦¬κ°€ κ³ λ―Όν–λ μ„λΉ„μ¤ κ³„μΈµμ μμμ„±μ΄ λ¬΄λ„μ§„λ‹¤.μ΄ λ¬Έμ λ¥Ό ν•΄κ²°ν•λ ¤λ©΄ μ•μ„ λ°°μ΄ κ²ƒ μ²λΌ λ¦¬ν¬μ§€ν† λ¦¬μ—μ„ μμ™Έλ¥Ό λ³€ν™ν•΄μ„ λμ§€λ©΄ λλ‹¤.- `SQLException` -> `MyDuplicateKeyException`**MyDuplicateKeyException**```javapublic class MyDuplicateKeyException extends MyDbException {    public MyDuplicateKeyException() {    }    public MyDuplicateKeyException(String message) {        super(message);    }    public MyDuplicateKeyException(String message, Throwable cause) {        super(message, cause);    }    public MyDuplicateKeyException(Throwable cause) {        super(cause);    }}```- κΈ°μ΅΄μ— μ‚¬μ©ν–λ `MyDbException` μ„ μƒμ†λ°›μ•„μ„ μλ―Έμλ” κ³„μΈµμ„ ν•μ„±ν•λ‹¤. μ΄λ ‡κ²ν•λ©΄ λ°μ΄ν„°λ² μ΄μ¤ κ΄€λ ¨ μμ™ΈλΌλ” κ³„μΈµμ„ λ§λ“¤ μ μλ‹¤.- κ·Έλ¦¬κ³  μ΄λ¦„λ„ `MyDuplicateKeyException` μ΄λΌλ” μ΄λ¦„μ„ μ§€μ—λ‹¤. μ΄ μμ™Έλ” λ°μ΄ν„° μ¤‘λ³µμ κ²½μ°μ—λ§ λμ Έμ•Ό ν•λ‹¤.- μ΄ μμ™Έλ” μ°λ¦¬κ°€ μ§μ ‘ λ§λ“  κ²ƒμ΄κΈ° λ•λ¬Έμ—, JDBCλ‚ JPA κ°™μ€ νΉμ • κΈ°μ μ— μΆ…μ†μ μ΄μ§€ μ•λ‹¤. λ”°λΌμ„ μ΄ μμ™Έλ¥Ό μ‚¬μ©ν•λ”λΌλ„ μ„λΉ„μ¤ κ³„μΈµμ μμμ„±μ„ μ μ§€ν•  μ μλ‹¤. (ν–¥ν›„ JDBCμ—μ„ λ‹¤λ¥Έ κΈ°μ λ΅ λ°”κΎΈμ–΄λ„ μ΄ μμ™Έλ” κ·Έλ€λ΅ μ μ§€ν•  μ μλ‹¤.)**ExTranslatorV1Test**```javapublic class ExTranslatorV1Test {    static Logger log = LoggerFactory.getLogger(ExTranslatorV1Test.class);    Repository repository;    Service service;    @BeforeEach    void init() {        DriverManagerDataSource dataSource = new DriverManagerDataSource(URL, USERNAME, PASSWORD);        repository = new Repository(dataSource);        service = new Service(repository);    }    @Test    void duplicateKeySave() {        service.create("myId");        service.create("myId"); // μ¤‘λ³µ ID    }    static class Service {        private final Repository repository;        public Service(Repository repository) {            this.repository = repository;        }        public void create(String memberId) {            try {                repository.save(new Member(memberId, 0));                log.info("saveId={}", memberId);            } catch (MyDuplicateKeyException e) {                log.info("ν‚¤ μ¤‘λ³µ, λ³µκµ¬ μ‹λ„");                String retryId = generateNewId(memberId);                log.info("retryId={}", retryId);                repository.save(new Member(retryId, 0));            } catch (MyDbException e) {                log.info("λ°μ΄ν„° μ ‘κ·Ό κ³„μΈµ μμ™Έ", e);                throw e;            }        }        private String generateNewId(String memberId) {            return memberId + new Random().nextInt(10000);        }    }    static class Repository {        private final DataSource dataSource;        public Repository(DataSource dataSource) {            this.dataSource = dataSource;        }        public Member save(Member member) {            String sql = "insert into member(member_id, money) values(?,?)";            Connection con = null;            PreparedStatement pstmt = null;            try {                con = dataSource.getConnection();                pstmt = con.prepareStatement(sql);                pstmt.setString(1, member.getMemberId());                pstmt.setInt(2, member.getMoney());                pstmt.executeUpdate();                return member;            } catch (SQLException e) {                if (e.getErrorCode() == 23505) {                    throw new MyDuplicateKeyException(e);                }                throw new MyDbException(e);            } finally {                JdbcUtils.closeStatement(pstmt);                JdbcUtils.closeConnection(con);            }        }    }}```μ‹¤ν–‰ν•΄λ³΄λ©΄ λ‹¤μκ³Ό κ°™μ€ λ΅κ·Έλ¥Ό ν™•μΈν•  μ μλ‹¤.```textService - saveId=myIdService - ν‚¤ μ¤‘λ³µ, λ³µκµ¬ μ‹λ„Service - retryId=myId492```κ°™μ€ IDλ¥Ό μ €μ¥ν–μ§€λ§, μ¤‘κ°„μ— μμ™Έλ¥Ό μ΅μ•„μ„ λ³µκµ¬ν• κ²ƒμ„ ν™•μΈν•  μ μλ‹¤.```javacatch (SQLException e) {                if (e.getErrorCode() == 23505) {                    throw new MyDuplicateKeyException(e);                }                throw new MyDbException(e);            }```- `e.getErrorCode() == 23505` : μ¤λ¥ μ½”λ“κ°€ ν‚¤ μ¤‘λ³µ μ¤λ¥( `23505` )μΈ κ²½μ° `MyDuplicateKeyException` μ„ μƒλ΅ λ§λ“¤μ–΄μ„ μ„λΉ„μ¤ κ³„μΈµμ— λμ§„λ‹¤.- λ‚λ¨Έμ§€ κ²½μ° κΈ°μ΅΄μ— λ§λ“¤μ—λ `MyDbException` μ„ λμ§„λ‹¤.```java public void create(String memberId) {            try {                repository.save(new Member(memberId, 0));                log.info("saveId={}", memberId);            } catch (MyDuplicateKeyException e) {                log.info("ν‚¤ μ¤‘λ³µ, λ³µκµ¬ μ‹λ„");                String retryId = generateNewId(memberId);                log.info("retryId={}", retryId);                repository.save(new Member(retryId, 0));            } catch (MyDbException e) {                log.info("λ°μ΄ν„° μ ‘κ·Ό κ³„μΈµ μμ™Έ", e);                throw e;            }        }```- μ²μμ— μ €μ¥μ„ μ‹λ„ν•λ‹¤. λ§μ•½ λ¦¬ν¬μ§€ν† λ¦¬μ—μ„ `MyDuplicateKeyException` μμ™Έκ°€ μ¬λΌμ¤λ©΄ μ΄ μμ™Έλ¥Ό μ΅λ”λ‹¤.- μμ™Έλ¥Ό μ΅μ•„μ„ `generateNewId(memberId)` λ΅ μƒλ΅μ΄ ID μƒμ„±μ„ μ‹λ„ν•λ‹¤. κ·Έλ¦¬κ³  λ‹¤μ‹ μ €μ¥ν•λ‹¤. μ—¬κΈ°κ°€ μμ™Έλ¥Ό λ³µκµ¬ν•λ” λ¶€λ¶„μ΄λ‹¤.- λ§μ•½ λ³µκµ¬ν•  μ μ—†λ” μμ™Έ( `MyDbException` )λ©΄ λ΅κ·Έλ§ λ‚¨κΈ°κ³  λ‹¤μ‹ μμ™Έλ¥Ό λμ§„λ‹¤. -> μμ™Έλ¥΄ λμ§€μ§€ μ•μ•„λ„ μ–΄μ°¨ν”Ό λ°νƒ€μ„ μ—λ¬λΌ μλ™ throw    - μ°Έκ³ λ΅ μ΄ κ²½μ° μ—¬κΈ°μ„ μμ™Έ λ΅κ·Έλ¥Ό λ‚¨κΈ°μ§€ μ•μ•„λ„ λλ‹¤. μ–΄μ°¨ν”Ό λ³µκµ¬ν•  μ μ—†λ” μμ™Έλ” μμ™Έλ¥Ό κ³µν†µμΌλ΅ μ²λ¦¬ν•λ” λ¶€λ¶„κΉμ§€ μ „λ‹¬λκΈ° λ•λ¬Έμ΄λ‹¤. λ”°λΌμ„ μ΄λ ‡κ² λ³µκµ¬ ν•  μ μ—†λ” μμ™Έλ” κ³µν†µμΌλ΅ μμ™Έλ¥Ό μ²λ¦¬ν•λ” κ³³μ—μ„ μμ™Έ λ΅κ·Έλ¥Ό λ‚¨κΈ°λ” κ²ƒμ΄ μΆ‹λ‹¤. μ—¬κΈ°μ„λ” λ‹¤μ–‘ν•κ² μμ™Έλ¥Ό μ΅μ•„μ„ μ²λ¦¬ν•  μ      μλ” μ μ„ λ³΄μ—¬μ£ΌκΈ° μ„ν•΄ μ΄κ³³μ— μ½”λ“λ¥Ό λ§λ“¤μ–΄λ‘μ—λ‹¤.**μ •λ¦¬**- SQL ErrorCodeλ΅ λ°μ΄ν„°λ² μ΄μ¤μ— μ–΄λ–¤ μ¤λ¥κ°€ μλ”μ§€ ν™•μΈν•  μ μμ—λ‹¤.- μμ™Έ λ³€ν™μ„ ν†µν•΄ `SQLException` μ„ νΉμ • κΈ°μ μ— μμ΅΄ν•μ§€ μ•λ” μ§μ ‘ λ§λ“  μμ™ΈμΈ `MyDuplicateKeyException` λ΅ λ³€ν™ ν•  μ μμ—λ‹¤.- λ¦¬ν¬μ§€ν† λ¦¬ κ³„μΈµμ΄ μμ™Έλ¥Ό λ³€ν™ν•΄μ¤€ λ•λ¶„μ— μ„λΉ„μ¤ κ³„μΈµμ€ νΉμ • κΈ°μ μ— μμ΅΄ν•μ§€ μ•λ” `MyDuplicateKeyException` μ„ μ‚¬μ©ν•΄μ„ λ¬Έμ λ¥Ό λ³µκµ¬ν•κ³ , μ„λΉ„μ¤ κ³„μΈµμ μμμ„±λ„ μ μ§€ν•  μ μμ—λ‹¤.**λ‚¨μ€ λ¬Έμ **- SQL ErrorCodeλ” κ°κ°μ λ°μ΄ν„°λ² μ΄μ¤ λ§λ‹¤ λ‹¤λ¥΄λ‹¤. κ²°κ³Όμ μΌλ΅ λ°μ΄ν„°λ² μ΄μ¤κ°€ λ³€κ²½λ  λ• λ§λ‹¤ ErrorCodeλ„ λ¨λ‘ λ³€κ²½ν•΄μ•Ό ν•λ‹¤.    - μ) ν‚¤ μ¤‘λ³µ μ¤λ¥ μ½”λ“        - H2: 23505        - MySQL: 1062- λ°μ΄ν„°λ² μ΄μ¤κ°€ μ „λ‹¬ν•λ” μ¤λ¥λ” ν‚¤ μ¤‘λ³µ λΏλ§ μ•„λ‹λΌ λ½μ΄ κ±Έλ¦° κ²½μ°, SQL λ¬Έλ²•μ— μ¤λ¥ μλ” κ²½μ° λ“±λ“± μμ‹­ μλ°±κ°€μ§€ μ¤λ¥ μ½”λ“κ°€ μλ‹¤. μ΄ λ¨λ“  μƒν™©μ— λ§λ” μμ™Έλ¥Ό μ§€κΈμ²λΌ λ‹¤ λ§λ“¤μ–΄μ•Ό ν• κΉ? μ¶”κ°€λ΅ μ•μ„ μ΄μ•ΌκΈ°ν• κ²ƒ μ²λΌ λ°μ΄ν„°λ² μ΄μ¤λ§λ‹¤ μ΄ μ¤λ¥ μ½”λ“λ” λ¨λ‘ λ‹¤λ¥΄λ‹¤.### μ¤ν”„λ§ μμ™Έ μ¶”μƒν™” μ΄ν•΄μ¤ν”„λ§μ€ μ•μ„ μ„¤λ…ν• λ¬Έμ λ“¤μ„ ν•΄κ²°ν•κΈ° μ„ν•΄ λ°μ΄ν„° μ ‘κ·Όκ³Ό κ΄€λ ¨λ μμ™Έλ¥Ό μ¶”μƒν™”ν•΄μ„ μ κ³µν•λ‹¤.**μ¤ν”„λ§ λ°μ΄ν„° μ ‘κ·Ό μμ™Έ κ³„μΈµ**![image](https://user-images.githubusercontent.com/83503188/188817292-21aae5bd-3fd3-4e57-8e83-4337fad64067.png)- μ¤ν”„λ§μ€ λ°μ΄ν„° μ ‘κ·Ό κ³„μΈµμ— λ€ν• μμ‹­ κ°€μ§€ μμ™Έλ¥Ό μ •λ¦¬ν•΄μ„ μΌκ΄€λ μμ™Έ κ³„μΈµμ„ μ κ³µν•λ‹¤.- κ°κ°μ μμ™Έλ” νΉμ • κΈ°μ μ— μΆ…μ†μ μ΄μ§€ μ•κ² μ„¤κ³„λμ–΄ μλ‹¤. λ”°λΌμ„ μ„λΉ„μ¤ κ³„μΈµμ—μ„λ„ μ¤ν”„λ§μ΄ μ κ³µν•λ” μμ™Έλ¥Ό μ‚¬μ©ν•λ©΄ λλ‹¤. μλ¥Ό λ“¤μ–΄μ„ JDBC κΈ°μ μ„ μ‚¬μ©ν•λ“ , JPA κΈ°μ μ„ μ‚¬μ©ν•λ“  μ¤ν”„λ§μ΄ μ κ³µν•λ” μμ™Έλ¥Ό μ‚¬μ©ν•λ©΄ λλ‹¤.- JDBCλ‚ JPAλ¥Ό μ‚¬μ©ν•  λ• λ°μƒν•λ” μμ™Έλ¥Ό μ¤ν”„λ§μ΄ μ κ³µν•λ” μμ™Έλ΅ λ³€ν™ν•΄μ£Όλ” μ—­ν• λ„ μ¤ν”„λ§μ΄ μ κ³µν•λ‹¤.- μ°Έκ³ λ΅ κ·Έλ¦Όμ„ λ‹¨μν™” ν•κΈ° μ„ν•΄ μΌλ¶€ κ³„μΈµμ„ μƒλµν–λ‹¤.- μμ™Έμ μµκ³  μƒμ„λ” `org.springframework.dao.DataAccessException` μ΄λ‹¤. κ·Έλ¦Όμ—μ„ λ³΄λ” κ²ƒ μ²λΌ λ°νƒ€μ„ μμ™Έλ¥Ό μƒμ† λ°›μ•κΈ° λ•λ¬Έμ— μ¤ν”„λ§μ΄ μ κ³µν•λ” λ°μ΄ν„° μ ‘κ·Ό κ³„μΈµμ λ¨λ“  μμ™Έλ” λ°νƒ€μ„ μμ™Έμ΄λ‹¤.- `DataAccessException` μ€ ν¬κ² 2κ°€μ§€λ΅ κµ¬λ¶„ν•λ”λ° NonTransient μμ™Έμ™€ Transient μμ™Έμ΄λ‹¤.    - `Transient` λ” μΌμ‹μ μ΄λΌλ” λ»μ΄λ‹¤. Transient ν•μ„ μμ™Έλ” λ™μΌν• SQLμ„ λ‹¤μ‹ μ‹λ„ν–μ„ λ• μ„±κ³µν•  κ°€λ¥μ„±μ΄ μλ‹¤.        - μλ¥Ό λ“¤μ–΄μ„ μΏΌλ¦¬ νƒ€μ„μ•„μ›ƒ, λ½κ³Ό κ΄€λ ¨λ μ¤λ¥λ“¤μ΄λ‹¤. μ΄λ° μ¤λ¥λ“¤μ€ λ°μ΄ν„°λ² μ΄μ¤ μƒνƒκ°€ μΆ‹μ•„μ§€κ±°λ‚, λ½μ΄ ν’€λ Έμ„ λ• λ‹¤μ‹ μ‹λ„ν•λ©΄ μ„±κ³µν•  μ λ„ μλ‹¤.    - `NonTransient` λ” μΌμ‹μ μ΄μ§€ μ•λ‹¤λ” λ»μ΄λ‹¤. κ°™μ€ SQLμ„ κ·Έλ€λ΅ λ°λ³µν•΄μ„ μ‹¤ν–‰ν•λ©΄ μ‹¤ν¨ν•λ‹¤.        - SQL λ¬Έλ²• μ¤λ¥, λ°μ΄ν„°λ² μ΄μ¤ μ μ•½μ΅°κ±΄ μ„λ°° λ“±μ΄ μλ‹¤.![image](https://user-images.githubusercontent.com/83503188/188818681-1256b25e-6dd9-453c-8979-adcdc7f650fc.png)### μ¤ν”„λ§μ΄ μ κ³µν•λ” μμ™Έ λ³€ν™κΈ°μ¤ν”„λ§μ€ λ°μ΄ν„°λ² μ΄μ¤μ—μ„ λ°μƒν•λ” μ¤λ¥ μ½”λ“λ¥Ό μ¤ν”„λ§μ΄ μ •μν• μμ™Έλ΅ μλ™μΌλ΅ λ³€ν™ν•΄μ£Όλ” λ³€ν™κΈ°λ¥Ό μ κ³µν•λ‹¤.μλ¥Όλ“¤μ–΄ `SQLException` μ΄ λ°μƒν•λ©΄ μ¤ν”„λ§μ΄ λ¶„μ„ν•μ—¬ μλ™μΌλ΅ `BadGrammerException` μΌλ΅ λ³€ν™ν•΄μ¤€λ‹¤.```javapublic class SpringExceptionTranslatorTest {    static Logger log = LoggerFactory.getLogger(ExTranslatorV1Test.class);    DataSource dataSource;    @BeforeEach    void init() {        dataSource = new DriverManagerDataSource(URL, USERNAME, PASSWORD);    }    @Test    void sqlExceptionErrorCode() {        String sql = "select bad grammar";        try {            Connection con = dataSource.getConnection();            PreparedStatement stmt = con.prepareStatement(sql);            stmt.executeQuery();        } catch (SQLException e) {            assertThat(e.getErrorCode()).isEqualTo(42122);            // μ§μ ‘ λ³€ν™ν•΄μ„ λμ Έμ£Όλ” κ²ƒμ€ ν„μ‹¤μ„±μ΄ μ—†λ‹¤.//            throw new BadSqlGrammarException(e);            int errorCode = e.getErrorCode();            log.info("errorCode={}", errorCode);            //org.h2.jdbc.JdbcSQLSyntaxErrorException            log.info("error", e);        }    }}```- μ΄μ „μ— μ‚΄ν΄λ΄¤λ SQL ErrorCodeλ¥Ό μ§μ ‘ ν™•μΈν•λ” λ°©λ²•μ΄λ‹¤. μ΄λ ‡κ² μ§μ ‘ μμ™Έλ¥Ό ν™•μΈν•κ³  ν•λ‚ν•λ‚ μ¤ν”„λ§μ΄ λ§λ“¤μ–΄μ¤€ μμ™Έλ΅ λ³€ν™ν•λ” κ²ƒμ€ ν„μ‹¤μ„±μ΄ μ—†λ‹¤. μ΄λ ‡κ² ν•λ ¤λ©΄ ν•΄λ‹Ή μ¤λ¥ μ½”λ“λ¥Ό ν™•μΈν•κ³  μ¤ν”„λ§μ μμ™Έ μ²΄κ³„μ— λ§μ¶”μ–΄ μμ™Έλ¥Ό μ§μ ‘ λ³€ν™ν•΄μ•Ό ν•  κ²ƒμ΄λ‹¤. κ·Έλ¦¬κ³  λ°μ΄ν„°λ² μ΄μ¤λ§λ‹¤ μ¤λ¥ μ½”λ“κ°€ λ‹¤λ¥΄λ‹¤λ” μ λ„ ν•΄κ²°ν•΄μ•Ό ν•λ‹¤.- κ·Έλμ„ μ¤ν”„λ§μ€ μμ™Έ λ³€ν™κΈ°λ¥Ό μ κ³µν•λ‹¤.**SpringExceptionTranslatorTest - μ¶”κ°€ exceptionTranslator**```java@Test    void exceptionTranslator() {        String sql = "select bad grammar";        try {            Connection con = dataSource.getConnection();            PreparedStatement stmt = con.prepareStatement(sql);            stmt.executeQuery();        } catch (SQLException e) {            assertThat(e.getErrorCode()).isEqualTo(42122);            SQLErrorCodeSQLExceptionTranslator exceptionTranslator = new SQLErrorCodeSQLExceptionTranslator(dataSource);            DataAccessException resultEx = exceptionTranslator.translate("select", sql, e);            log.info("resultEx", resultEx);            assertThat(resultEx.getClass()).isEqualTo(BadSqlGrammarException.class);        }    }```- `translate()` λ©”μ„λ“μ μ²«λ²μ§Έ νλΌλ―Έν„°λ” μ½μ„ μ μλ” μ„¤λ…μ΄κ³ , λ‘λ²μ§Έλ” μ‹¤ν–‰ν• sql, λ§μ§€λ§‰μ€ λ°μƒλ`SQLException` μ„ μ „λ‹¬ν•λ©΄ λλ‹¤. μ΄λ ‡κ² ν•λ©΄ μ μ ν• μ¤ν”„λ§ λ°μ΄ν„° μ ‘κ·Ό κ³„μΈµμ μμ™Έλ΅ λ³€ν™ν•΄μ„ λ°ν™ν•΄μ¤€λ‹¤.- μμ μ—μ„λ” SQL λ¬Έλ²•μ΄ μλ»λμ—μΌλ―€λ΅ `BadSqlGrammarException` μ„ λ°ν™ν•λ” κ²ƒμ„ ν™•μΈν•  μ μλ‹¤.    - λμ— λ³΄μ΄λ” λ°ν™ νƒ€μ…μ€ μµμƒμ„ νƒ€μ…μΈ `DataAccessException` μ΄μ§€λ§ μ‹¤μ λ΅λ” `BadSqlGrammarException` μμ™Έκ°€ λ°ν™λλ‹¤. λ§μ§€λ§‰μ— `assertThat()` λ¶€λ¶„μ„ ν™•μΈν•μ.    - μ°Έκ³ λ΅ `BadSqlGrammarException` μ€ μµμƒμ„ νƒ€μ…μΈ `DataAccessException` λ¥Ό μƒμ† λ°›μ•„μ„ λ§λ“¤μ–΄μ§„λ‹¤.κ°κ°μ DBλ§λ‹¤ SQL ErrorCodeλ” λ‹¤λ¥΄λ‹¤. κ·Έλ°λ° μ¤ν”„λ§μ€ μ–΄λ–»κ² κ°κ°μ DBκ°€ μ κ³µν•λ” SQL ErrorCodeκΉμ§€ κ³ λ ¤ν•΄μ„ μμ™Έλ¥Ό λ³€ν™ν•  μ μμ„κΉ?λΉ„λ°€μ€ λ°”λ΅ λ‹¤μ νμΌμ— μλ‹¤.**sql-error-codes.xml**```xml<beans>	<bean id="DB2" name="Db2" class="org.springframework.jdbc.support.SQLErrorCodes">		<property name="databaseProductName">			<value>DB2*</value>		</property>		<property name="badSqlGrammarCodes">			<value>-007,-029,-097,-104,-109,-115,-128,-199,-204,-206,-301,-408,-441,-491</value>		</property>		<property name="duplicateKeyCodes">			<value>-803</value>		</property>		<property name="dataIntegrityViolationCodes">			<value>-407,-530,-531,-532,-543,-544,-545,-603,-667</value>		</property>		<property name="dataAccessResourceFailureCodes">			<value>-904,-971</value>		</property>		<property name="transientDataAccessResourceCodes">			<value>-1035,-1218,-30080,-30081</value>		</property>		<property name="deadlockLoserCodes">			<value>-911,-913</value>		</property>	</bean>...</beans>```### μ¤ν”„λ§ μμ™Έ μ¶”μƒν™” μ μ©**MemberRepositoryV4_2**```java/** * SQLExceptionTranslator μ¶”κ°€ */@Slf4jpublic class MemberRepositoryV4_2 implements MemberRepository {    private final DataSource dataSource;    private final SQLExceptionTranslator exceptionTranslator;    public MemberRepositoryV4_2(DataSource dataSource) {        this.dataSource = dataSource;        this.exceptionTranslator = new SQLErrorCodeSQLExceptionTranslator(dataSource);    }    public Member save(Member member) {        String sql = "insert into member(member_id, money) values (?, ?)";        Connection con = null;        PreparedStatement pstmt = null; // PreparedStatement κ°μ²΄λ¥Ό κ°€μ§€κ³  μ‹¤μ  DBμ— μΏΌλ¦¬λ¥Ό μ‹¤ν–‰ν•λ‹¤.        try {            con = getConnection();            pstmt = con.prepareStatement(sql);            // νλΌλ―Έν„° λ°”μΈλ”©            pstmt.setString(1, member.getMemberId());            pstmt.setInt(2, member.getMoney());            pstmt.executeUpdate(); // μΏΌλ¦¬ μ‹¤ν–‰, λ°ν™κ°’μ€ μν–¥μ„ λ°›μ€ row μ            return member;        } catch (SQLException e) {            throw exceptionTranslator.translate("save", sql, e);        } finally {            close(con, pstmt, null);        }    }    public Member findById(String memberId) {        String sql = "select * from member where member_id = ?";        Connection con = null;        PreparedStatement pstmt = null; // PreparedStatement κ°μ²΄λ¥Ό κ°€μ§€κ³  μ‹¤μ  DBμ— μΏΌλ¦¬λ¥Ό μ‹¤ν–‰ν•λ‹¤.        ResultSet rs = null;        try {            con = getConnection();            pstmt = con.prepareStatement(sql);            // νλΌλ―Έν„° λ°”μΈλ”©            pstmt.setString(1, memberId);            rs = pstmt.executeQuery(); // λ°μ΄ν„°λ¥Ό λ³€κ²½ν•  λ•λ” executeUpdate() λ¥Ό μ‚¬μ©ν•μ§€λ§, λ°μ΄ν„°λ¥Ό μ΅°νν•  λ•λ” executeQuery() λ¥Ό μ‚¬μ©ν•λ‹¤. executeQuery() λ” κ²°κ³Όλ¥Ό ResultSet μ— λ‹΄μ•„μ„ λ°ν™ν•λ‹¤.            if (rs.next()) {                Member member = new Member();                member.setMemberId(rs.getString("member_id"));                member.setMoney(rs.getInt("money"));                return member;            } else {                throw new NoSuchElementException("member not found memberId=" + memberId);            }        } catch (SQLException e) {            throw exceptionTranslator.translate("findById", sql, e);        } finally {            close(con, pstmt, rs);        }    }    public void update(String memberId, int money) {        String sql = "update member set money = ? where member_id = ?";        Connection con = null;        PreparedStatement pstmt = null; // PreparedStatement κ°μ²΄λ¥Ό κ°€μ§€κ³  μ‹¤μ  DBμ— μΏΌλ¦¬λ¥Ό μ‹¤ν–‰ν•λ‹¤.        try {            con = getConnection();            pstmt = con.prepareStatement(sql);            // νλΌλ―Έν„° λ°”μΈλ”©            pstmt.setInt(1, money);            pstmt.setString(2, memberId);            int resultSize = pstmt.executeUpdate();            log.info("resultSize={}", resultSize);        } catch (SQLException e) {            throw exceptionTranslator.translate("update", sql, e);        } finally {            close(con, pstmt, null);        }    }    public void delete(String memberId) {        String sql = "delete from member where member_id = ?";        Connection con = null;        PreparedStatement pstmt = null; // PreparedStatement κ°μ²΄λ¥Ό κ°€μ§€κ³  μ‹¤μ  DBμ— μΏΌλ¦¬λ¥Ό μ‹¤ν–‰ν•λ‹¤.        try {            con = getConnection();            pstmt = con.prepareStatement(sql);            // νλΌλ―Έν„° λ°”μΈλ”©            pstmt.setString(1, memberId);            pstmt.executeUpdate();        } catch (SQLException e) {            throw exceptionTranslator.translate("delete", sql, e);        } finally {            close(con, pstmt, null);        }    }    private void close(Connection con, Statement stmt, ResultSet rs) {        JdbcUtils.closeResultSet(rs);        JdbcUtils.closeStatement(stmt);        DataSourceUtils.releaseConnection(con, dataSource);    }    private Connection getConnection() throws SQLException {        Connection con = DataSourceUtils.getConnection(dataSource);        log.info("get connection={}, class={}", con, con.getClass());        return con;    }}```**MemberServiceV4Test - μμ •**```java@SpringBootTestclass MemberServiceV4Test {    Logger log = LoggerFactory.getLogger(MemberServiceV4Test.class);    @Autowired    private MemberRepository memberRepository;    @Autowired    private MemberServiceV4 memberService;    @TestConfiguration    static class TestConfig {        private final DataSource dataSource;        public TestConfig(DataSource dataSource) {            this.dataSource = dataSource;        }        @Bean        MemberRepository memberRepositoryV4() {            return new MemberRepositoryV4_2(dataSource);        }...}``````java private void bizLogic(String fromId, String toId, int money) {        Member fromMember = memberRepository.findById(fromId);        Member toMember = memberRepository.findById(toId);        try {            memberRepository.update(fromId, fromMember.getMoney() - money);        }catch (DuplicateKeyException e) {            ...        }}```### JDBC λ°λ³µ λ¬Έμ  ν•΄κ²° - JdbcTemplateμ§€κΈκΉμ§€ μ„λΉ„μ¤ κ³„μΈµμ μμν•¨μ„ μ μ§€ν•κΈ° μ„ν•΄ μ λ§μ€ λ…Έλ ¥μ„ ν–κ³ , λ•λ¶„μ— μ„λΉ„μ¤ κ³„μΈµμ μμν•¨μ„ μ μ§€ν•κ² λμ—λ‹¤. μ΄λ²μ—λ” λ¦¬ν¬μ§€ν† λ¦¬μ—μ„ JDBCλ¥Ό μ‚¬μ©ν•κΈ° λ•λ¬Έμ— λ°μƒν•λ” λ°λ³µ λ¬Έμ λ¥Ό ν•΄κ²°ν•΄λ³΄μ.**JDBC λ°λ³µ λ¬Έμ **1. μ»¤λ„¥μ… μ΅°ν, μ»¤λ„¥μ… λ™κΈ°ν™” -> `con = getConnection();`2. PreparedStatement μƒμ„± λ° νλΌλ―Έν„° λ°”μΈλ”©```javapstmt = con.prepareStatement(sql);// νλΌλ―Έν„° λ°”μΈλ”©pstmt.setString(1, member.getMemberId());pstmt.setInt(2, member.getMoney());```3. μΏΌλ¦¬ μ‹¤ν–‰ -> `pstmt.executeUpdate();`4. κ²°κ³Ό λ°”μΈλ”©```javars = pstmt.executeQuery(); // λ°μ΄ν„°λ¥Ό λ³€κ²½ν•  λ•λ” executeUpdate() λ¥Ό μ‚¬μ©ν•μ§€λ§, λ°μ΄ν„°λ¥Ό μ΅°νν•  λ•λ” executeQuery() λ¥Ό μ‚¬μ©ν•λ‹¤. executeQuery() λ” κ²°κ³Όλ¥Ό ResultSet μ— λ‹΄μ•„μ„ λ°ν™ν•λ‹¤. if (rs.next()) { 	Member member = new Member(); 	member.setMemberId(rs.getString("member_id"));	member.setMoney(rs.getInt("money"));	return member; }```5. μμ™Έ λ°μƒμ‹ μ¤ν”„λ§ μμ™Έ λ³€ν™κΈ° μ‹¤ν–‰```javacatch (SQLException e) {            throw exceptionTranslator.translate("findById", sql, e);        }```6. λ¦¬μ†μ¤ μΆ…λ£```javafinally {            close(con, pstmt, rs);        }```sqlκ³Ό κ²°κ³Όλ°”μΈλ”© μ μ™Έν•κ³  κ±°μ λΉ„μ·ν• μ½”λ“κ°€ λ°λ³µλκ³ μλ‹¤.λ¦¬ν¬μ§€ν† λ¦¬μ κ°κ°μ λ©”μ„λ“λ¥Ό μ‚΄ν΄λ³΄λ©΄ μƒλ‹Ήν λ§μ€ λ¶€λ¶„μ΄ λ°λ³µλλ‹¤. μ΄λ° λ°λ³µμ„ ν¨κ³Όμ μΌλ΅ μ²λ¦¬ν•λ” λ°©λ²•μ΄ λ°”λ΅ ν…ν”λ¦Ώ μ½λ°± ν¨ν„΄μ΄λ‹¤.μ¤ν”„λ§μ€ JDBCμ λ°λ³µ λ¬Έμ λ¥Ό ν•΄κ²°ν•κΈ° μ„ν•΄ `JdbcTemplate` μ΄λΌλ” ν…ν”λ¦Ώμ„ μ κ³µν•λ‹¤.**MemberRepositoryV5**```java/** * JdbcTemplate μ‚¬μ© */@Slf4jpublic class MemberRepositoryV5 implements MemberRepository {    private final JdbcTemplate template;    public MemberRepositoryV5(DataSource dataSource) {        this.template = new JdbcTemplate(dataSource);    }    @Override    public Member save(Member member) {        String sql = "insert into member(member_id, money) values (?, ?)";        template.update(sql, member.getMemberId(), member.getMoney()); // update row μ λ¦¬ν„΄        return member;    }    @Override    public Member findById(String memberId) {        String sql = "select * from member where member_id = ?";        return template.queryForObject(sql, memberRowMapper(), memberId);    }    @Override    public void update(String memberId, int money) {        String sql = "update member set money = ? where member_id = ?";        template.update(sql, money, memberId);    }    @Override    public void delete(String memberId) {        String sql = "delete from member where member_id = ?";        template.update(sql, memberId);    }    private RowMapper<Member> memberRowMapper() {        return (rs, rowNum) -> {            Member member = new Member();            member.setMemberId(rs.getString("member_id"));            member.setMoney(rs.getInt("money"));            return member;        };    }}```**MemberServiceV4Test - μμ •**```java@BeanMemberRepository memberRepository() {    //return new MemberRepositoryV4_1(dataSource); //λ‹¨μ μμ™Έ λ³€ν™    //return new MemberRepositoryV4_2(dataSource); //μ¤ν”„λ§ μμ™Έ λ³€ν™    return new MemberRepositoryV5(dataSource); //JdbcTemplate}````MemberRepository` μΈν„°νμ΄μ¤κ°€ μ κ³µλλ―€λ΅ λ“±λ΅ν•λ” λΉλ§ `MemberRepositoryV5` λ΅ λ³€κ²½ν•΄μ„ λ“±λ΅ν•λ©΄ λλ‹¤.`JdbcTemplate` μ€ JDBCλ΅ κ°λ°ν•  λ• λ°μƒν•λ” λ°λ³µμ„ λ€λ¶€λ¶„ ν•΄κ²°ν•΄μ¤€λ‹¤. κ·Έ λΏλ§ μ•„λ‹λΌ μ§€κΈκΉμ§€ ν•™μµν–λ, νΈλμ­μ…μ„ μ„ν• μ»¤λ„¥μ… λ™κΈ°ν™”λ” λ¬Όλ΅ μ΄κ³ , μμ™Έ λ°μƒμ‹ μ¤ν”„λ§ μμ™Έ λ³€ν™κΈ°λ„ μλ™μΌλ΅ μ‹¤ν–‰ν•΄μ¤€λ‹¤.**μ •λ¦¬**μ™„μ„±λ μ½”λ“λ¥Ό ν™•μΈν•΄λ³΄μ.- μ„λΉ„μ¤ κ³„μΈµμ μμμ„±    - νΈλμ­μ… μ¶”μƒν™” + νΈλμ­μ… AOP λ•λ¶„μ— μ„λΉ„μ¤ κ³„μΈµμ μμμ„±μ„ μµλ€ν• μ μ§€ν•λ©΄μ„ μ„λΉ„μ¤ κ³„μΈµμ—μ„ νΈλμ­μ…μ„ μ‚¬μ©ν•  μ μλ‹¤.    - μ¤ν”„λ§μ΄ μ κ³µν•λ” μμ™Έ μ¶”μƒν™”μ™€ μμ™Έ λ³€ν™κΈ° λ•λ¶„μ—, λ°μ΄ν„° μ ‘κ·Ό κΈ°μ μ΄ λ³€κ²½λμ–΄λ„ μ„λΉ„μ¤ κ³„μΈµμ μμμ„±μ„ μ μ§€ν•λ©΄μ„ μμ™Έλ„ μ‚¬μ©ν•  μ μλ‹¤.    - μ„λΉ„μ¤ κ³„μΈµμ΄ λ¦¬ν¬μ§€ν† λ¦¬ μΈν„°νμ΄μ¤μ— μμ΅΄ν• λ•λ¶„μ— ν–¥ν›„ λ¦¬ν¬μ§€ν† λ¦¬κ°€ λ‹¤λ¥Έ κµ¬ν„ κΈ°μ λ΅ λ³€κ²½λμ–΄λ„ μ„λΉ„μ¤ κ³„μΈµμ„ μμν•κ² μ μ§€ν•  μ μλ‹¤.- λ¦¬ν¬μ§€ν† λ¦¬μ—μ„ JDBCλ¥Ό μ‚¬μ©ν•λ” λ°λ³µ μ½”λ“κ°€ `JdbcTemplate` μΌλ΅ λ€λ¶€λ¶„ μ κ±°λμ—λ‹¤.